<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #e1e1e1;
            --secondary-text-color: #8a8a8a;
            --primary-color: #3b82f6;
            --border-color: #2d2d2d;
            --hover-color: #2a2a2a;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100%;
            max-width: 800px;
            background-color: var(--surface-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
        .hidden {
            display: none !important;
        }
        #auth-container {
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            max-width: 400px;
            max-height: 500px;
            border-radius: 8px;
        }
        #auth-container h1 {
            color: var(--primary-text-color);
        }
        #auth-container input {
            width: 90%;
            padding: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border-radius: 6px;
        }
        #auth-container button {
            width: calc(90% + 24px);
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        #google-login-button {
            background-color: #4285F4;
        }
        #auth-container p {
            color: var(--secondary-text-color);
        }
        #auth-container a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        #chat-container .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color);
            flex-shrink: 0;
        }
        #chat-container .header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: 500;
        }
        #chat-container .header button {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        #chat-container .header button:hover {
            background-color: var(--hover-color);
            color: var(--primary-text-color);
        }
        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            margin-bottom: 15px;
            max-width: 75%;
        }
        .message .profile-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }
        .message-content {
            padding: 10px 15px;
            border-radius: 20px;
        }
        .message-content strong {
            display: block;
            font-size: 13px;
            color: var(--secondary-text-color);
            margin-bottom: 4px;
            font-weight: 500;
        }
        .message-content div {
            line-height: 1.4;
        }
        .sent {
            flex-direction: row-reverse;
            align-self: flex-end;
        }
        .sent .message-content {
            background-color: var(--primary-color);
            color: #fff;
        }
        .sent .profile-pic {
            margin-right: 0;
            margin-left: 12px;
        }
        .received {
            align-self: flex-start;
        }
        .received .message-content {
            background-color: #363636;
        }
        #typing-indicator {
            height: 30px;
            padding: 0 20px;
            color: var(--secondary-text-color);
            font-style: italic;
            font-size: 14px;
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #typing-indicator.visible {
            opacity: 1;
        }
        .typing-dots span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: var(--secondary-text-color);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        #chat-controls {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #message-input {
            flex-grow: 1;
            border: none;
            background-color: #2c2c2c;
            color: var(--primary-text-color);
            border-radius: 20px;
            padding: 10px 18px;
            margin-right: 10px;
            font-size: 15px;
        }
        #message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 16px;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        #send-button:hover {
            transform: scale(1.1);
        }
        #settings-container {
            padding: 20px;
            align-items: center;
            gap: 15px;
        }
        #settings-container .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }
        #settings-container input {
            width: 80%;
            padding: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border-radius: 6px;
        }
        #settings-container button {
            width: calc(80% + 24px);
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
        }
        #back-to-chat-button {
            background-color: #555;
        }
        @media (max-width: 800px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>

    <div id="auth-container" class="container">
        <div id="login-view">
            <h1>Login</h1>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Senha">
            <button id="login-button">Entrar</button>
            <button id="google-login-button">Entrar com Google</button>
            <p>Não tem uma conta? <a href="#" id="show-register">Cadastre-se</a></p>
        </div>
        <div id="register-view" class="hidden">
            <h1>Cadastro</h1>
            <input type="text" id="register-name" placeholder="Seu Nome">
            <input type="email" id="register-email" placeholder="Email">
            <input type="password" id="register-password" placeholder="Senha">
            <button id="register-button">Cadastrar</button>
            <p>Já tem uma conta? <a href="#" id="show-login">Faça Login</a></p>
        </div>
    </div>

    <div id="chat-container" class="container hidden">
        <div class="header">
            <h1 id="welcome-message"></h1>
            <div>
                <button id="settings-button" title="Configurações"><i class="fas fa-cog"></i></button>
                <button id="logout-button" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div id="chat-box"></div>
        <div id="typing-indicator"></div>
        <div id="chat-controls">
            <input type="text" id="message-input" placeholder="Digite sua mensagem...">
            <button id="send-button" title="Enviar"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="settings-container" class="container hidden">
        <h1>Configurações do Perfil</h1>
        <img id="settings-photo" src="" alt="Foto do Perfil" class="profile-pic">
        <p><strong>Email:</strong> <span id="settings-email"></span></p>
        <input type="text" id="settings-name" placeholder="Novo nome de exibição">
        <input type="text" id="settings-photo-url" placeholder="URL da nova foto">
        <button id="update-profile-button">Salvar Alterações</button>
        <button id="back-to-chat-button">Voltar para o Chat</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJN4ylUCR3GFY-6G-oHIdOKlrLPLYb0OE",
            authDomain: "chat-conversation-71277.firebaseapp.com",
            projectId: "chat-conversation-71277",
            storageBucket: "chat-conversation-71277.appspot.com",
            messagingSenderId: "995855170501",
            appId: "1:995855170501:web:6d51bd110f166fb93469ac"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messagesCollection = db.collection('mensagens');
        const typingCollection = db.collection('digitando');

        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const settingsContainer = document.getElementById('settings-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');

        const showChatView = () => {
            authContainer.classList.add('hidden');
            settingsContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
        };

        const showAuthView = () => {
            chatContainer.classList.add('hidden');
            settingsContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
        };

        const showSettingsView = () => {
            chatContainer.classList.add('hidden');
            authContainer.classList.add('hidden');
            settingsContainer.classList.remove('hidden');
            const user = auth.currentUser;
            if (user) {
                document.getElementById('settings-photo').src = user.photoURL || 'https://via.placeholder.com/100';
                document.getElementById('settings-email').textContent = user.email;
                document.getElementById('settings-name').value = user.displayName || '';
                document.getElementById('settings-photo-url').value = user.photoURL || '';
            }
        };

        let unsubscribeMessages = null;
        let unsubscribeTyping = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('welcome-message').textContent = `Bem-vindo, ${user.displayName || user.email}!`;
                showChatView();
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeTyping) unsubscribeTyping();
                listenForMessages();
                listenForTyping();
            } else {
                showAuthView();
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeTyping) unsubscribeTyping();
            }
        });

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        document.getElementById('register-button').addEventListener('click', () => {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    return userCredential.user.updateProfile({
                        displayName: name,
                        photoURL: `https://ui-avatars.com/api/?name=${name.replace(' ', '+')}&background=random&color=fff`
                    });
                })
                .catch(error => alert(error.message));
        });

        document.getElementById('login-button').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(error.message));
        });

        document.getElementById('google-login-button').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => alert(error.message));
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            updateUserTyping(false);
            auth.signOut();
        });

        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        const sendMessage = () => {
            const text = messageInput.value.trim();
            const user = auth.currentUser;
            if (text === '' || !user) return;
            messagesCollection.add({
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                uid: user.uid,
                displayName: user.displayName,
                photoURL: user.photoURL
            })
            .then(() => {
                messageInput.value = '';
                updateUserTyping(false);
                clearTimeout(typingTimeout);
            })
            .catch(error => console.error("Erro ao enviar mensagem:", error));
        };

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function listenForMessages() {
            unsubscribeMessages = messagesCollection.orderBy('timestamp').onSnapshot(snapshot => {
                chatBox.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageElement = document.createElement('div');
                    const currentUser = auth.currentUser;
                    const messageClass = (currentUser && message.uid === currentUser.uid) ? 'sent' : 'received';
                    messageElement.classList.add('message', messageClass);
                    messageElement.innerHTML = `
                        <img src="${message.photoURL || 'https://via.placeholder.com/40'}" alt="Foto" class="profile-pic">
                        <div class="message-content">
                            <strong>${message.displayName || 'Anônimo'}</strong>
                            <div>${message.text}</div>
                        </div>
                    `;
                    chatBox.appendChild(messageElement);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            }, error => console.error("Erro ao ouvir mensagens:", error));
        }

        const typingIndicator = document.getElementById('typing-indicator');
        let typingTimeout;

        const updateUserTyping = (isTyping) => {
            const user = auth.currentUser;
            if (!user) return;
            const userTypingRef = typingCollection.doc(user.uid);
            if (isTyping) {
                userTypingRef.set({
                    displayName: user.displayName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                userTypingRef.delete();
            }
        };

        messageInput.addEventListener('input', () => {
            clearTimeout(typingTimeout);
            updateUserTyping(true);
            typingTimeout = setTimeout(() => {
                updateUserTyping(false);
            }, 2000);
        });

        function listenForTyping() {
            unsubscribeTyping = typingCollection.onSnapshot(snapshot => {
                const typingUsers = [];
                const now = Date.now();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const user = auth.currentUser;
                    if (user && doc.id !== user.uid && data.timestamp && (now - data.timestamp.toDate().getTime()) < 10000) {
                        typingUsers.push(data.displayName);
                    }
                });
                if (typingUsers.length > 0) {
                    let text = `${typingUsers.join(', ')} está${typingUsers.length > 1 ? 'm' : ''} digitando`;
                    typingIndicator.innerHTML = `${text} <div class="typing-dots"><span></span><span></span><span></span></div>`;
                    typingIndicator.classList.add('visible');
                } else {
                    typingIndicator.classList.remove('visible');
                }
            }, error => console.error("Erro ao ouvir status de digitação:", error));
        }

        document.getElementById('settings-button').addEventListener('click', showSettingsView);
        document.getElementById('back-to-chat-button').addEventListener('click', showChatView);

        document.getElementById('update-profile-button').addEventListener('click', () => {
            const user = auth.currentUser;
            const newName = document.getElementById('settings-name').value;
            const newPhotoURL = document.getElementById('settings-photo-url').value;
            if (user) {
                user.updateProfile({
                    displayName: newName,
                    photoURL: newPhotoURL
                }).then(() => {
                    alert("Perfil atualizado com sucesso!");
                    document.getElementById('welcome-message').textContent = `Bem-vindo, ${newName}!`;
                    showChatView();
                }).catch(error => alert(error.message));
            }
        });
    </script>
</body>
</html>
